<!DOCTYPE html>
<html>
<head>
  <title>Ride Home | AlinGo</title>
</head>
<body>

<h2>Welcome to Ride Module</h2>

<!-- User Greeting -->
<p id="greet"></p>

<!-- Current Rides -->
<h3>Your Rides:</h3>
<ul id="rideList"></ul>

<!-- Book Ride Button -->
<button onclick="location.href='ride-book.html'">Book Ride</button>

<script>
async function init(){
  const token = localStorage.getItem("token");
  if(!token){
    alert("Please login first");
    location.href="/login.html";
    return;
  }

  // Optional: decode payload safely
  try{
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const payload = JSON.parse(decodeURIComponent(atob(base64).split('').map(function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join('')));
    document.getElementById("greet").innerText = "Hello, " + (payload.phone || "User") + "!";
  } catch(e){
    document.getElementById("greet").innerText = "Hello, User!";
  }

  // Fetch current rides
  try{
    const res = await fetch("/api/ride/my", {
      headers:{ "Authorization":"Bearer "+token }
    });
    if(!res.ok) throw new Error("Failed to fetch rides");

    const data = await res.json();
    const rides = data.rides || data; // depending on backend response

    const list = document.getElementById("rideList");
    list.innerHTML = "";
    if(rides.length === 0){
      list.innerHTML = "<li>No rides yet</li>";
    } else {
      rides.forEach(r=>{
        const li = document.createElement("li");
        li.innerText = `${r.pickup} â†’ ${r.drop} | Status: ${r.status}`;
        list.appendChild(li);
      });
    }
  } catch(err){
    console.error(err);
    document.getElementById("rideList").innerHTML = "<li>Error loading rides</li>";
  }
}

init();
</script>

</body>
</html>
